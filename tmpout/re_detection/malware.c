#include <sys/ptrace.h>
#include <sys/signal.h>
#include <stdio.h>

int debugger = 1;
void handler(int signal)
{
	debugger = 0;
}

int main(void)
{
	// If SIGTRAP is raised inside a debugging environment,
	// then it will not go into the handler defined here.
	// Would be better if this piece ran after PTRACE_TRACEME,
	// but couldn't make the program work in that case.
	signal(SIGTRAP, &handler);
	raise(SIGTRAP);
	if (debugger) {
		puts("Normal stuff");
		return 0;
	}

	// If the program is already being ptrace'd, then this
	// will return EPERM, a non-zero value.
	if (ptrace(PTRACE_TRACEME, 0, 0, 0)) {
		puts("Normal stuff");
		return 0;
	}

	puts("Malware stuff");
	return 0;
}
